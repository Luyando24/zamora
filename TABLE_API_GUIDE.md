# Table Number Fetching API Guide for Mobile Developers

This guide explains how to fetch table information (table numbers, types, and details) for the Zamora mobile application.

## Overview
In the Zamora system, **Tables** are stored in the same table as hotel rooms but are distinguished by their category. When fetching tables, you are essentially querying "rooms" that have a type categorized as `table`.

---

## 1. Fetch All Tables
Retrieve a list of all tables registered for a specific property. This is used by waiters and cashiers to select a table when placing or managing orders.

- **Endpoint:** `GET /api/mobile/manager/tables`
- **Query Parameters:**
  - `propertyId` (Required): The UUID of the property.
- **Authentication:** Bearer Token.
- **Authorized Roles:** `waiter`, `cashier`, `manager`, `owner`, `admin`, `chef`, `bartender`.

### Request Example:
```bash
GET /api/mobile/manager/tables?propertyId=YOUR_PROPERTY_ID
Authorization: Bearer YOUR_JWT_TOKEN
```

### Response Example:
```json
[
  {
    "id": "table-uuid-1",
    "property_id": "prop-uuid",
    "room_number": "Table 1",
    "room_type_id": "type-uuid-1",
    "status": "available",
    "notes": "Near window",
    "room_types": {
      "name": "Standard Table",
      "category": "table"
    }
  },
  {
    "id": "table-uuid-2",
    "property_id": "prop-uuid",
    "room_number": "Table 2",
    "room_type_id": "type-uuid-1",
    "status": "occupied",
    "notes": null,
    "room_types": {
      "name": "Standard Table",
      "category": "table"
    }
  }
]
```

---

## 2. Table Status Logic
The `status` field for a table is now **dynamically calculated** based on the presence of active orders. You do not need to manually update the table status when placing an order; the system handles this automatically.

### Status Definitions:
- **`available`**: The table has no ongoing orders, or all orders associated with this table have been paid/completed (`pos_completed` status) or cancelled.
- **`occupied`**: The table has at least one active order in any of the following states: `pending`, `preparing`, `ready`, or `delivered`, provided it hasn't been paid yet.

### Developer Instructions:
1. **Fetching Tables**: Always use the `GET /api/mobile/manager/tables` endpoint to get the most up-to-date status.
2. **Placing Orders**: When an order is placed for a table (via `POST /api/mobile/orders`), the table will automatically show as `occupied` in subsequent fetch requests.
3. **Settling Orders**: When an order is marked as paid/completed (via POS), the table will automatically return to `available`.

---

## 3. Fetch Table Types
Retrieve the available types of tables (e.g., "VIP Table", "Standard Table", "Bar Stool").

- **Endpoint:** `GET /api/mobile/manager/table-types`
- **Query Parameters:**
  - `propertyId` (Required): The UUID of the property.
- **Authentication:** Bearer Token.

### Response Example:
```json
[
  {
    "id": "type-uuid-1",
    "name": "Standard Table",
    "description": "Seats 4 people",
    "capacity": 4,
    "base_price": 0,
    "category": "table"
  }
]
```

---

---

## 4. QR Code & Scanner Implementation

To ensure that scanning a table QR code provides a frictionless experience:

1.  **URL Format**: The QR codes generated by the dashboard follow this format:
    `https://zamoraapp.com/menu/[propertyId]?table=[tableNumber]`

2.  **Auto-Open Requirement**: The mobile app's internal scanner must be configured to **automatically** process the scanned URL and navigate to the corresponding menu/table screen.
    -   **Avoid** showing an "Open Link" button or any confirmation dialog.
    -   **Validate** the domain to ensure it's a Zamora URL.
    -   **Extract** the `propertyId` and `table` parameter to load the correct menu state immediately.

3.  **Note on System Cameras**: While the native phone camera will always show a tap-to-open banner (due to OS security policies), the goal is to provide the "Auto-Open" experience within the Zamora app itself.

---
- **Authentication:** Bearer Token.

---

## Common Issues & Troubleshooting

### 1. "Unauthorized" or "Forbidden" Error
- **Cause:** The user's JWT token is invalid, expired, or the user does not have permission for the property.
- **Fix:** Ensure you are passing the `propertyId` in the query string and that the logged-in user is registered as staff for that property with an authorized role (`waiter`, `cashier`, etc.).

### 2. Empty Array Returned
- **Cause:** No tables have been created for this property yet, or they are categorized incorrectly.
- **Fix:** Ask the manager to add tables via the Dashboard under "Tables".

### 3. Missing `propertyId`
- **Cause:** The API requires `propertyId` to filter results and verify access.
- **Fix:** Always append `?propertyId=...` to your GET requests.

## Data Schema Note
| Field | Description |
|-------|-------------|
| `room_number` | This is the actual **Table Number** (e.g., "T1", "12"). |
| `status` | Current status: **`available`** or **`occupied`**. |
| `room_types.name` | The descriptive name of the table type. |
